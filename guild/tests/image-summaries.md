# Image Summaries

Guild supports ephemeral image summaries when viewing runs in
TensorBoard.

It works like this:

1. A run generates one or more images.

2. While running, Guild TensorBoard scans run dirs for generated images
   and includs them in an ephemeral summary log so they appear in
   TensorBoard for the applicable run.

To illustrate we'll use the `image-summaries` project.

    >>> project = Project(sample("projects", "image-summaries"))

The `copy-images` operation makes a copy of project-defined images.

    >>> run, _out = project.run_capture("copy-images")

Here are the run files:

    >>> files = dir(run.dir)
    >>> files
    ['.guild', 'favicon-copy.png', 'favicon.png']

The file `favicon.png` is a link to the project source file.

    >>> os.path.islink(path(run.dir, "favicon.png"))
    True

The file `favicon-copy.png` is generated by the run - it is not a
link.

    >>> os.path.islink(path(run.dir, "favicon-copy.png"))
    False

Next we'll process these files using the TensorBoard runs
monitor. This monitor checks runs for images and adds them to
ephemeral summary logs in a log directory.

    >>> from guild.tensorboard import RunsMonitor

Let's create a log directory. This is where the monitor stores run
summary logs.

    >>> logdir = mkdtemp()

The monitor needs a callback for listing runs. We'll use the project.

    >>> list_runs_cb = project.list_runs

And our monitor, configured to log only images:

    >>> monitor = RunsMonitor(logdir, list_runs_cb, logspec=["images"])

The monitor is designed to run a thread but we can run it preemptively
by calling `run_once`.

Let's first verify that our log directory is empty.

    >>> find(logdir)
    <empty>

And run the monitor:

    >>> monitor.run_once()

The monitor generated the following files in the log directory:

    >>> files = findl(logdir)
    >>> files
    ['... copy-images .../.guild/...',
     '... copy-images .../events.out.tfevents.0000000000.images']

The first file is a marker corresponding to the processed image page.

    >>> import hashlib
    >>> digest = hashlib.md5(b"favicon-copy.png").hexdigest()

    >>> print(digest)
    71a365d27894b323b8d5d6ebfeed6ee9

    >>> file0 = basename(files[0])
    >>> digest == file0, (digest, file0)
    (True, ...)

The second file is the TF event summary log containing run images. We
can use `tfevent.EventReader` to read the log events.

    >>> from guild.tfevent import EventReader

Event readers read from the directory containing the TF event logs.

    >>> event_log_dir = path(logdir, dirname(files[1]))

Here's our event reader:

    >>> events = EventReader(event_log_dir)

Before reading the events, we need to setup TensorBoard logging to
surpress logging messages from the TensorBoard library.

    >>> from guild import tensorboard
    >>> tensorboard.setup_logging()

And the logged events:

    >>> for event in events:
    ...     print(event)
    summary {
      value {
        tag: "favicon-copy.png"
        image {
          height: 180
          width: 180
          colorspace: 4
          encoded_image_string: "..."
        }
      }
    }
