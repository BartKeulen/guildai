# Guild Example: `multiple-models`

This example shows how to define multiple models in a Guild file. It
defines two models, each corresponding to the original TensorFlow "red
and blue pill" tutorial examples.

Highlights:

- Shared config across model definitions
- Model resources

This example shows basic flag usage. It also demonstrates simple file
dependencies.

- [guild.yml](guild.yml) - Project Guild file
- [intro.py](intro.py) - Basic classifier
- [expert.py](expert.py) - Advanced classifier

[guild.yml](guild.yml) defines two models: `mnist-intro` and
`mnist-expert`.

List the models:

```
$ guild models
mnist-expert  MNIST model from TensorFlow expert tutorial
mnist-intro   MNIST model from TensorFlow intro tutorial
```

List the operations:

```
mnist-expert:evaluate  Evaluate a trained model using test data
mnist-expert:train     Train the MNIST model
mnist-intro:evaluate   Evaluate a trained model using test data
mnist-intro:train      Train the MNIST model
```

Note that each model shares the same set of operatio names. These are
defined in a shared config:

``` yaml
- config: mnist-base
  operations:
    train:
      description: Train the MNIST model
      main: '{{main}} --datadir data --rundir .'
      requires: data
      compare:
        - =epochs
        - =batch-size
        - =lr
        - train#loss step as step
        - train#loss as loss
        - validate#accuracy as accuracy
      objective:
        maximize: validate#accuracy
      flags-import: no
      flags-dest: args
      flags:
        batch-size:
          description: Number of images to include in a training batch
          default: 100
          required: yes
        epochs:
          description: Number of epochs to train
          default: 10
        lr:
          description: Training learning rate
          default: 0.5
    evaluate:
      description: Evaluate a trained model using test data
      main: '{{main}} --test --datadir data --rundir .'
      flags-import: no
      flags-dest: args
      requires:
        - data
        - sources:
            - operation: train
              select: model
      compare:
        - loss step as step
        - loss
        - accuracy
  resources:
    data:
      description: "Yann Lecun's MNIST dataset in compressed IDX format"
      private: yes
      path: data
      sources:
      - url: http://yann.lecun.com/exdb/mnist/train-images-idx3-ubyte.gz
        sha256: 440fcabf73cc546fa21475e81ea370265605f56be210a4024d2ca8f203523609
      - url: http://yann.lecun.com/exdb/mnist/train-labels-idx1-ubyte.gz
        sha256: 3552534a0a558bbed6aed32b30c495cca23d567ec52cac8be1a0730e8010255c
      - url: http://yann.lecun.com/exdb/mnist/t10k-images-idx3-ubyte.gz
        sha256: 8d422c7b0a1c1c79245a5bcf07fe86e33eeafee792b84584aec276f5a2dbc4e6
      - url: http://yann.lecun.com/exdb/mnist/t10k-labels-idx1-ubyte.gz
        sha256: f7ae60f92e00ec6debd23a6088c31dbd2371eca3ffa0defaefb259924204aec6
```

Each model _extends_ this shared config:

``` yaml
- model: mnist-intro
  description: MNIST model from TensorFlow intro tutorial
  extends: mnist-base
  params:
    main: intro

- model: mnist-expert
  description: MNIST model from TensorFlow expert tutorial
  extends: mnist-base
  params:
    main: expert
  operations:
    train:
      flags:
        lr: 1e-4
```

Notes about implementation:

- The `compare` attribute defines the columns that appear when a run
  appears in Guild Compare and Guild View. The use of ``=`` prefix
  indicates that the name refers to a flag. Otherwise Guild assumes
  the name refers to a scalar. The use of ``as <value>`` is used to
  control what label is used for the column.

- The combination of ``flags-import: no`` and ``flags-dest: args``
  will cause Guild to skip scanning the main module. Since Guild knows
  a) not to import flags and b) that the flag interface is via command
  line args, it doesn't need to examine the main module.

- The `objective` attribute specifies the scalar used in
  optimizations. When ``guild run mnist-intro:train --optimize`` is
  run, the optimizer attempts to maximize validation accuracy.

- The `evaluate` operation requires output from a `train`
  operation. This is specified by the `requires` attribute. `evaluate`
  only needs the `model` directory generated by `train` and so selects
  this directory explicitly using `select`.

- When a model extends `config` or another `model`, it can redefine
  operation attributes. In this example, `mnist-export` uses a
  different default learning rate.
